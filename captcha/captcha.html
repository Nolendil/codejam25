<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hangman</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style type="text/css">
    html,
    body {
      background: pink;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #captcha-container {
      background: white;
	  background-image: url("bg.png");
      width: 390px;
      height: 300px;
    }

	.hidden {
		display: none;
	}

	#title {
		width: 100%;
		text-align: center;
	}

	#hint {
		position: absolute;
		top: 100px;
		left: 10px;
		width: 165px;
		text-align: center;
	}

	#lives {
		position: absolute;
		top: 250px;
		left: 45px;
		width: 300px;
		text-align: center;
	}
  </style>
</head>

<body>
  <div id="captcha-container">
    <div id="title">Find the <span id="word-length"></span> letter word...</div>
	<div>Possible words:<span id="possible-words"></span></div>
	<div>Wrong: <span id="wrong"></span></div>
	<div>Correct: <span id="correct"></span></div>
	<div id="lives"></div>
	<div id="hint">
		<span id="hint-text"></span>
		<button id="try-again" class="hidden">Try again!</button>
	</div>
  </div>

  <script type="text/javascript" src="4_letter_words.json"></script>
  <script type="text/javascript" src="5_letter_words.json"></script>

  <script type="text/javascript">
    (function(window, document){
		let wordLength = 5;
		let attempts = 4;
		let parsedWords = JSON.parse((wordLength === 5) ? words5 : words4);
		let availableWords = [];
		{
			let parsedWordsFlat = [];
			for (let w of parsedWords) {
				parsedWordsFlat.push(w.word.toLowerCase());
			}
			parsedWords = parsedWordsFlat;
		}
		let wrongLetters = [];
		let correctLetters = [];
		const wordLengthElement = document.getElementById("word-length");
		const wordCountElement = document.getElementById("possible-words");
		const hintElement = document.getElementById("hint-text");
		const wrongElement = document.getElementById("wrong");
		const correctElement = document.getElementById("correct");
		const livesElement = document.getElementById("lives");
		const tryAgainButton = document.getElementById("try-again");
		tryAgainButton.addEventListener('click', () => reset(true))
		window.onkeyup = onKey;
		reset(false);

		function reset(bRetry) {
			if (bRetry) {
				attempts = Math.min(Math.floor(attempts * 1.5), 26);
			}
			tryAgainButton.classList.add("hidden");
			availableWords = Array.from(parsedWords);
			wordLengthElement.textContent = wordLength;
			wrongLetters = [];
			correctLetters = [];
			hintElement.textContent = "Hint: " + getUnicodeChar(0x13000, 0x1342E) + getUnicodeChar(0x1F700, 0x1F773) + getUnicodeChar(0x1F90C, 0x1F9FF);
			update();
		}
		
		function getUnicodeChar(begingRange, endRange) {
			let rand = Math.floor(begingRange + (Math.random() * (endRange - begingRange + 1)));
			return String.fromCodePoint(rand);
		}
		
		function update() {
			wordCountElement.textContent = availableWords.length + (availableWords.length <= 10 ? (" [" + availableWords + "]") : "");
			wrongElement.textContent = "(" + wrongLetters.length + "/" + attempts + ") " + wrongLetters;
			correctElement.textContent = "(" + correctLetters.length + "/" + wordLength + ") " + correctLetters;
			livesElement.textContent = "";
			for (let life = 0; life < attempts; life++) {
				if (life < (attempts - wrongLetters.length)) {
					livesElement.textContent += String.fromCodePoint(0x1F9E1);
				} else {
					livesElement.textContent += String.fromCodePoint(0x1F90D);
				}
			}
		}
		
		function onKey(e) {
			// Losing state, discard keys until reset
			if (wrongLetters.length >= attempts)
				return;

			let key = e.key;
			// Check if letter
			if (key.length !== 1 || !key.match(/[a-z]/i))
				return;
			// Already tried
			if (wrongLetters.includes(key) || correctLetters.includes(key)) {
				return;
			}

			// Eliminate words that contains that letter if possible
			let newAvailableWords = [];
			for (let w of availableWords) {
				if (!w.includes(key))
				{
					newAvailableWords.push(w);
				}
			}
			if (newAvailableWords.length > 0) {
				wrongLetters.push(key);
				availableWords = newAvailableWords;
			} else {
				// We have to accept the letter
				correctLetters.push(key);
				// Remove words that don't contain that letter
				newAvailableWords = [];
				for (let w of availableWords) {
					if (w.includes(key)) {
						newAvailableWords.push(w);
					}
				}
				if (newAvailableWords.length > 0) {
					availableWords = newAvailableWords;
				} else {
					// Oops, this shouldn't happen, right? If it does, free success!
					console.log("Secret ending, congrats!");
					win();
					return;
				}
			}
			
			// Check we it's impossible to refuse more letters => Win
			let bWin = true;
			CanFitMoreLetters: {
				for (let w of availableWords) {
					for (let l of w) {
						if (!correctLetters.includes(l)) {
							bWin = false;
							break CanFitMoreLetters;
						}
					}
				}
			}
			if (bWin) {
				win();
				return;
			}

			if (wrongLetters.length >= attempts)
			{
				lose();
				return;
			}

			update();
		}

		function win() {
			update();
			hintElement.innerHTML = "SUCCESS!<br>The word was: " + availableWords[0];
			captchaSuccess();
		}

		function lose() {
			update();
			hintElement.innerHTML = "YOU LOST!<br>The word was: " + availableWords[Math.floor(Math.random() * availableWords.length)];
			tryAgainButton.classList.remove("hidden");
		}
	
		// Tell the parent window that the CAPTCHA was successful
		function captchaSuccess() {
			window.top.postMessage("success", '*');
		}
    })(window, document);
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Hanging with our crow friend!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style type="text/css">
    html,
    body {
      background: pink;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #captcha-container {
      background: white;
	  background-image: url("bg.png");
      width: 390px;
      height: 300px;
    }

	.hidden {
		display: none;
	}

	.debug {
		display: none;
	}

	#title {
		width: 100%;
		text-align: center;
	}

	#wrong, .wrong {
		color:green;
		font-weight: bold;
	}

	#correct, .correct {
		color: red;
	}

	#hint {
		position: absolute;
		top: 95px;
		left: 10px;
		width: 165px;
		text-align: center;
	}

	#lives {
		position: absolute;
		top: 200px;
		left: 45px;
		width: 300px;
		text-align: center;
	}

	#vkeyboard {
		position: absolute;
		top: 250px;
		left: 0px;
		width: 390px;
		text-align: center;
	}

	.vkey {
		min-width: 24px;
	}
  </style>
</head>

<body>
  <div id="captcha-container">
    <div id="title">Find the <span id="word-length"></span> letter word...</div>
	<div class="debug" style="background-color: gray; width: fit-content;">Possible words: <span id="possible-words"></span></div>
	<div class="debug" style="background-color: gray; width: fit-content;">Wrong: <span id="wrong"></span></div>
	<div class="debug" style="background-color: gray; width: fit-content;">Correct: <span id="correct"></span></div>
	<div id="hint">
		<div id="message-text"></div>
		<div id="hint-text"></div>
		<button id="try-again" class="hidden">Try again!</button>
		<button id="win" class="hidden">You're a human!</button>
	</div>
	<div id="vkeyboard"></div>
	<div id="lives"></div>
  </div>

  <script type="text/javascript" src="4_letter_words.json"></script>
  <script type="text/javascript" src="5_letter_words.json"></script>

  <script type="text/javascript">
    (function(window, document){
		/// You can adjust difficulty by modifying the values below:
		let wordLength = 5; // only 4 or 5
		let attempts = 4;
		const attemptMultiplierOnRetry = 1.5;
		/// Debug
		const bDebug = false;	//true;
		if (bDebug) {
			let debugElements = document.getElementsByClassName("debug");
			while(debugElements.length > 0) {
				debugElements[0].classList.remove("debug");
			}
		}
		///
		let parsedWords = JSON.parse((wordLength === 5) ? words5 : words4);
		let availableWords = [];
		{
			let parsedWordsFlat = [];
			for (let w of parsedWords) {
				parsedWordsFlat.push(w.word.toLowerCase());
			}
			parsedWords = parsedWordsFlat;
		}
		let wrongLetters = [];
		let correctLetters = [];
		const wordLengthElement = document.getElementById("word-length");
		const wordCountElement = document.getElementById("possible-words");
		const hintElement = document.getElementById("hint-text");
		const messageElement = document.getElementById("message-text");
		const wrongElement = document.getElementById("wrong");
		const correctElement = document.getElementById("correct");
		const livesElement = document.getElementById("lives");
		const vkbElement = document.getElementById("vkeyboard");
		const tryAgainButton = document.getElementById("try-again");
		const winButton = document.getElementById("win");
		tryAgainButton.addEventListener('click', () => reset(true));
		winButton.addEventListener('click', () => captchaSuccess());
		window.onkeyup = onKey;
		drawVKeyboard();
		reset(false);

		function drawVKeyboard() {
			for (let indexLetter = 'a'.charCodeAt(0); indexLetter <= 'z'.charCodeAt(0); indexLetter++) {
				let newVKeyElement = document.createElement("button");
				let strLetter = String.fromCharCode(indexLetter);
				newVKeyElement.textContent = strLetter.toUpperCase();
				newVKeyElement.classList.add("vkey");
				newVKeyElement.id = "vkey" + strLetter;
				let eKey = new Event('keyup');
				eKey.key = strLetter;
				newVKeyElement.addEventListener('click', () => onKey(eKey));
				vkbElement.appendChild(newVKeyElement);
			}
		}

		function reset(bRetry) {
			if (bRetry) {
				attempts = Math.min(Math.floor(attempts * attemptMultiplierOnRetry), 26);
			}
			tryAgainButton.classList.add("hidden");
			winButton.classList.add("hidden");
			for (let keyElement of vkbElement.children) {
				keyElement.classList.remove("wrong", "correct");
			}
			availableWords = Array.from(parsedWords);
			wordLengthElement.textContent = wordLength;
			wrongLetters = [];
			correctLetters = [];
			hintElement.textContent = "Hint: " + getUnicodeChar(0x13000, 0x1342E) + getUnicodeChar(0x1F700, 0x1F773) + getUnicodeChar(0x1F90C, 0x1F9FF);
			messageElement.innerHTML = "";
			update();
		}
		
		function getUnicodeChar(begingRange, endRange) {
			let rand = Math.floor(begingRange + (Math.random() * (endRange - begingRange + 1)));
			return String.fromCodePoint(rand);
		}
		
		function update() {
			wordCountElement.textContent = availableWords.length + (availableWords.length <= 10 ? (" [" + availableWords + "]") : "");
			wrongElement.textContent = "(" + wrongLetters.length + "/" + attempts + ") " + wrongLetters;
			correctElement.textContent = "(" + correctLetters.length + "/" + wordLength + ") " + correctLetters;
			livesElement.textContent = "";
			for (let life = 0; life < attempts; life++) {
				if (life < (attempts - wrongLetters.length)) {
					livesElement.textContent += String.fromCodePoint(0x1F9E1);
				} else {
					livesElement.textContent += String.fromCodePoint(0x1F90D);
				}
			}
		}
		
		function onKey(e) {
			// Losing state, discard keys until reset
			if (wrongLetters.length >= attempts)
				return;

			let key = e.key;
			// Check if letter
			if (key.length !== 1 || !key.match(/[a-z]/i))
				return;
			// Already tried
			if (wrongLetters.includes(key) || correctLetters.includes(key)) {
				return;
			}

			// Eliminate words that contains that letter if possible
			let newAvailableWords = [];
			for (let w of availableWords) {
				if (!w.includes(key))
				{
					newAvailableWords.push(w);
				}
			}
			if (newAvailableWords.length > 0) {
				wrongLetters.push(key);
				document.getElementById("vkey" + key).classList.add("wrong");
				messageElement.innerHTML = key.toUpperCase() + " was <span class='wrong'>WRONG</span>!";
				availableWords = newAvailableWords;
			} else {
				// We have to accept the letter
				correctLetters.push(key);
				document.getElementById("vkey" + key).classList.add("correct");
				messageElement.innerHTML = key.toUpperCase() + " was <span class='correct'>CORRECT</span>!";
				// Remove words that don't contain that letter
				newAvailableWords = [];
				for (let w of availableWords) {
					if (w.includes(key)) {
						newAvailableWords.push(w);
					}
				}
				if (newAvailableWords.length > 0) {
					availableWords = newAvailableWords;
				} else {
					// Oops, this shouldn't happen, right? If it does, free success!
					console.log("Secret ending, congrats!");
					win();
					return;
				}
			}
			
			// Check we it's impossible to refuse more letters => Win
			let bWin = true;
			CanFitMoreLetters: {
				for (let w of availableWords) {
					for (let l of w) {
						if (!correctLetters.includes(l)) {
							bWin = false;
							break CanFitMoreLetters;
						}
					}
				}
			}
			if (bWin) {
				win();
				return;
			}

			if (wrongLetters.length >= attempts)
			{
				lose();
				return;
			}

			update();
		}

		function win() {
			update();
			hintElement.innerHTML = "SUCCESS!<br>The word was: " + availableWords[0];
			winButton.classList.remove("hidden");
		}

		function lose() {
			update();
			hintElement.innerHTML = "YOU LOST!<br>The word was: " + availableWords[Math.floor(Math.random() * availableWords.length)];
			tryAgainButton.classList.remove("hidden");
		}
	
		// Tell the parent window that the CAPTCHA was successful
		function captchaSuccess() {
			window.top.postMessage("success", '*');
		}
    })(window, document);
  </script>
</body>
</html>
